<!DOCTYPE html>






  


<html class="theme-next mist use-motion" lang="zh-Hans,en,default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="lUQzK8OpPUQRTvyQMUIZHvPVeGh5WViymHuZewwc7qs" />




















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="TL;DR This article show how Whisper work and some Linux programming tricks it used.">
<meta property="og:type" content="article">
<meta property="og:title" content="Introduce to the implement of Whisper: the time-serial database">
<meta property="og:url" content="https://blog.xiaoquankong.ai/introduce-to-the-implement-of-whisper-the-time-serial-database/index.html">
<meta property="og:site_name" content="Howl&#39;s">
<meta property="og:description" content="TL;DR This article show how Whisper work and some Linux programming tricks it used.">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-08-13T11:08:02.493Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Introduce to the implement of Whisper: the time-serial database">
<meta name="twitter:description" content="TL;DR This article show how Whisper work and some Linux programming tricks it used.">



  <link rel="alternate" href="/atom.xml" title="Howl's" type="application/atom+xml" />




  <link rel="canonical" href="https://blog.xiaoquankong.ai/introduce-to-the-implement-of-whisper-the-time-serial-database/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Introduce to the implement of Whisper: the time-serial database | Howl's</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-105150423-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-105150423-2');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Howl's</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.xiaoquankong.ai/introduce-to-the-implement-of-whisper-the-time-serial-database/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaoquan Kong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Howl's">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Introduce to the implement of Whisper: the time-serial database
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-10-05 18:49:49" itemprop="dateCreated datePublished" datetime="2016-10-05T18:49:49+08:00">2016-10-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-08-13 19:08:02" itemprop="dateModified" datetime="2018-08-13T19:08:02+08:00">2018-08-13</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/time-series-database/" itemprop="url" rel="index"><span itemprop="name">time-series-database</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/introduce-to-the-implement-of-whisper-the-time-serial-database/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="introduce-to-the-implement-of-whisper-the-time-serial-database/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>TL;DR</strong> This article show how Whisper work and some Linux programming tricks it used.<br><a id="more"></a></p>
<h2 id="What’s-the-Whisper"><a href="#What’s-the-Whisper" class="headerlink" title="What’s the Whisper"></a>What’s the Whisper</h2><p>Many people familiar with the famous metric monitor system: <a href="https://graphite.readthedocs.io" target="_blank" rel="noopener">graphite</a></p>
<p>Here are some introduce from official website of graphite:</p>
<blockquote>
<p>Graphite is an enterprise-scale monitoring tool that runs well on cheap hardware.</p>
<p>  Graphite does two things:</p>
<ul>
<li>Store numeric time-series data</li>
<li>Render graphs of this data on demand</li>
</ul>
</blockquote>
<p>Whisper is one of the core parts of graphite. There are two components of “Store numeric time-series data”: One for receive the data from network which is the job of Carbon, another for write the data into physical disk (like a database) which is the job of Whisper.</p>
<p>Officially, Whisper is a time-serial database or library which design for graphite project, but still very university as a time-serial database.</p>
<p><strong>Important</strong>:</p>
<p>Follow code / structure analysis based on <code>whisper==0.9.10</code>, different version may has different result.</p>
<h2 id="Overview-the-structure-of-the-Whisper-database"><a href="#Overview-the-structure-of-the-Whisper-database" class="headerlink" title="Overview the structure of the Whisper database"></a>Overview the structure of the Whisper database</h2><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Whisper is a single binary file database, each file have three parts: <code>Header</code> / <code>Archives</code> / <code>Data</code>. The reference implement (aka Whisper in Graphite) was wrote in Python with manipulate binary file with <code>struct</code> library.</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header of Whisper used to record meta-information such as <code>aggregationType</code> / <code>maxRetention</code> / <code>xff</code> / <code>archiveCount</code></p>
<h4 id="aggregationType"><a href="#aggregationType" class="headerlink" title="aggregationType"></a>aggregationType</h4><p>Data type: long int (aka ‘L’ in <code>struct</code> format). <code>aggregationType</code> control how the higher precision aggregate to lower precision.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aggregationTypeToMethod = dict(&#123;</span><br><span class="line">    <span class="number">1</span>: <span class="string">'average'</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">'sum'</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">'last'</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">'max'</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">'min'</span>,</span><br><span class="line">    <span class="number">6</span>: <span class="string">'avg_zero'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="maxRetention"><a href="#maxRetention" class="headerlink" title="maxRetention"></a>maxRetention</h4><p>Data type: long int. <code>maxRetention</code> show the max retention this database can hold. The unit of this field is second.</p>
<h4 id="xff"><a href="#xff" class="headerlink" title="xff"></a>xff</h4><p><code>xff</code> is the abbreviation for <code>xFilesFactor</code>. Data type: Float (aka ‘l’ in <code>struct</code> format). When higher precision data aggregate to lower precision, if the proportion of valid data lower than this value, the result of aggregation will set to None.</p>
<h4 id="archiveCount"><a href="#archiveCount" class="headerlink" title="archiveCount"></a>archiveCount</h4><p>Data type: long int. <code>archiveCount</code> are used to count the number of archive.</p>
<h3 id="Archives"><a href="#Archives" class="headerlink" title="Archives"></a>Archives</h3><h4 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h4><p><code>Archives</code> are stored the meta-information of <code>Data</code> or <code>Data</code> is a part of <code>Archives</code>. Different archive means different precision and retention for data store.</p>
<p><code>Archives</code> field have several strict limitation:</p>
<ul>
<li>At least has one archive</li>
<li>Archive’s precision must strictly monotonically after ordered</li>
<li>Precision of lower archive must be a multiple of higher’s (not equal)</li>
<li>Archive’s retention must strictly monotonically too, the lower precision the longer retention</li>
<li>Archive of higher precision must have enough point to consolidate archive of lower precision</li>
</ul>
<p>Here comes an example for the last limitation:<br>Higher: 1s/20<br>Lower: 60s/1</p>
<p>This example fits first four limitation, but not the last one.</p>
<p>Those limitations are checked by:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> archiveList:</span><br><span class="line">    <span class="keyword">raise</span> InvalidConfiguration(<span class="string">"You must specify at least one archive configuration!"</span>)</span><br><span class="line"></span><br><span class="line">archiveList.sort(key=<span class="keyword">lambda</span> a: a[<span class="number">0</span>])  <span class="comment"># Sort by precision (secondsPerPoint)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, archive <span class="keyword">in</span> enumerate(archiveList):</span><br><span class="line">    <span class="keyword">if</span> i == len(archiveList) - <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    nextArchive = archiveList[i + <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> archive[<span class="number">0</span>] &lt; nextArchive[<span class="number">0</span>]:</span><br><span class="line">        <span class="keyword">raise</span> InvalidConfiguration(<span class="string">"A Whisper database may not be configured having "</span></span><br><span class="line">                                   <span class="string">"two archives with the same precision (archive%d: %s, archive%d: %s)"</span> %</span><br><span class="line">                                   (i, archive, i + <span class="number">1</span>, nextArchive))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> nextArchive[<span class="number">0</span>] % archive[<span class="number">0</span>] != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> InvalidConfiguration(<span class="string">"Higher precision archives' precision "</span></span><br><span class="line">                                   <span class="string">"must evenly divide all lower precision archives' precision "</span></span><br><span class="line">                                   <span class="string">"(archive%d: %s, archive%d: %s)"</span> %</span><br><span class="line">                                   (i, archive[<span class="number">0</span>], i + <span class="number">1</span>, nextArchive[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    retention = archive[<span class="number">0</span>] * archive[<span class="number">1</span>]</span><br><span class="line">    nextRetention = nextArchive[<span class="number">0</span>] * nextArchive[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> nextRetention &gt; retention:</span><br><span class="line">        <span class="keyword">raise</span> InvalidConfiguration(<span class="string">"Lower precision archives must cover "</span></span><br><span class="line">                                   <span class="string">"larger time intervals than higher precision archives "</span></span><br><span class="line">                                   <span class="string">"(archive%d: %s seconds, archive%d: %s seconds)"</span> %</span><br><span class="line">                                   (i, retention, i + <span class="number">1</span>, nextRetention))</span><br><span class="line"></span><br><span class="line">    archivePoints = archive[<span class="number">1</span>]</span><br><span class="line">    pointsPerConsolidation = nextArchive[<span class="number">0</span>] // archive[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> archivePoints &gt;= pointsPerConsolidation:</span><br><span class="line">        <span class="keyword">raise</span> InvalidConfiguration(<span class="string">"Each archive must have at least enough points "</span></span><br><span class="line">                                   <span class="string">"to consolidate to the next archive (archive%d consolidates %d of "</span></span><br><span class="line">                                   <span class="string">"archive%d's points but it has only %d total points)"</span> %</span><br><span class="line">                                   (i + <span class="number">1</span>, pointsPerConsolidation, i, archivePoints))</span><br></pre></td></tr></table></figure>
<h4 id="structure"><a href="#structure" class="headerlink" title="structure"></a>structure</h4><p><code>Archives</code> have three fields: <code>offset</code> / <code>secondsPerPoint</code> / <code>points</code></p>
<h5 id="offset"><a href="#offset" class="headerlink" title="offset"></a>offset</h5><p>Data type: long int. <code>offset</code> indicate the offset from the very begin of file.</p>
<h5 id="secondsPerPoint"><a href="#secondsPerPoint" class="headerlink" title="secondsPerPoint"></a>secondsPerPoint</h5><p>Data type: long int. <code>secondsPerPoint</code> is the precision of archive. Obviously the max precision is one-second per data point.</p>
<h5 id="points"><a href="#points" class="headerlink" title="points"></a>points</h5><p>Data type: long int. <code>points</code> indicate the capacity of this archive.</p>
<h5 id="derivative"><a href="#derivative" class="headerlink" title="derivative"></a>derivative</h5><p>Few derivative attribution, not exists in the fields but can be compute form those fields</p>
<h6 id="retention"><a href="#retention" class="headerlink" title="retention"></a>retention</h6><blockquote>
<p>retention = points * secondsPerPoint</p>
</blockquote>
<h6 id="size"><a href="#size" class="headerlink" title="size"></a>size</h6><p>Size of the <code>Data</code> field in physical occupation.</p>
<blockquote>
<p>size = points * pointSize</p>
</blockquote>
<p>pointSize will covered in the <code>Data</code> part, it is a fix size in Whisper.</p>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><h4 id="summary-1"><a href="#summary-1" class="headerlink" title="summary"></a>summary</h4><p>Data part are the actual data store part. Those parts are compose by <code>Point</code> which contain time and value information.</p>
<h4 id="Point"><a href="#Point" class="headerlink" title="Point"></a>Point</h4><p>each point have two parts: Interval, data</p>
<h5 id="Interval"><a href="#Interval" class="headerlink" title="Interval"></a>Interval</h5><p>Data type: Long int, UNIX timestamp</p>
<h5 id="Data-1"><a href="#Data-1" class="headerlink" title="Data"></a>Data</h5><p>Data type: Double (aka ‘d’ in struct format), store the metric value</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><h4 id="ASCII-Art-Chart"><a href="#ASCII-Art-Chart" class="headerlink" title="ASCII Art Chart"></a>ASCII Art Chart</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line">|AT|MR|xff|AC|offset|SPP|points|      ...      |Interval|data|     ...    |</span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line">|            |   Archive One   |      ...      |  Point One  |     ...    |</span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line">|    Header  |             Archives            |            Data          |</span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line">|                              Whisper file                               |</span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">AT: aggregationType</span><br><span class="line">MR: maxRetention</span><br><span class="line">AC: archiveCount</span><br><span class="line">SPP: secondsPerPoint</span><br></pre></td></tr></table></figure>
<h2 id="Create-process"><a href="#Create-process" class="headerlink" title="Create process"></a>Create process</h2><h3 id="pre-requires"><a href="#pre-requires" class="headerlink" title="pre-requires"></a>pre-requires</h3><p>There are two acquire pre-requires:</p>
<ul>
<li>path : the path of the database on disk</li>
<li>archiveList : List of all the archive, can not modified after create</li>
</ul>
<p>Two optional pre-requires:</p>
<ul>
<li>xFilesFactor = None</li>
<li>aggregationMethod = None</li>
</ul>
<h3 id="check-archiveList"><a href="#check-archiveList" class="headerlink" title="check archiveList"></a>check archiveList</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Validate archive configurations...</span></span><br><span class="line">validateArchiveList(archiveList)</span><br></pre></td></tr></table></figure>
<h4 id="Trap-on-the-implementation"><a href="#Trap-on-the-implementation" class="headerlink" title="Trap on the implementation"></a>Trap on the implementation</h4><p>Function <code>validateArchiveList</code> seems only check the validation of <code>archiveList</code> but actually also change the <code>archiveList</code> by execute order operation <code>archiveList.sort(key=lambda a: a[0])</code>. This is not a good design, if people don’t look at the implementation of <code>validateArchiveList</code>, their will never know <code>archiveList</code> already sorted. And because fallow code depend on the order of <code>archiveList</code>, if you don’t know this, you will don’t understand how the code works.</p>
<p>Also see <code>summary</code> section of <code>Archives</code> part</p>
<h3 id="Write-Header"><a href="#Write-Header" class="headerlink" title="Write Header"></a>Write Header</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aggregationType = struct.pack(longFormat, aggregationMethodToType.get(aggregationMethod, <span class="number">1</span>))</span><br><span class="line">oldest = max([secondsPerPoint * points <span class="keyword">for</span> secondsPerPoint, points <span class="keyword">in</span> archiveList])</span><br><span class="line">maxRetention = struct.pack(longFormat, oldest)</span><br><span class="line">xFilesFactor = struct.pack(floatFormat, float(xFilesFactor))</span><br><span class="line">archiveCount = struct.pack(longFormat, len(archiveList))</span><br><span class="line">packedMetadata = aggregationType + maxRetention + xFilesFactor + archiveCount</span><br><span class="line">fh.write(packedMetadata)</span><br></pre></td></tr></table></figure>
<h3 id="Write-ArchiveList"><a href="#Write-ArchiveList" class="headerlink" title="Write ArchiveList"></a>Write ArchiveList</h3><p>The key point of this process is the offset computing.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">headerSize = metadataSize + (archiveInfoSize * len(archiveList))</span><br><span class="line">archiveOffsetPointer = headerSize</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> secondsPerPoint, points <span class="keyword">in</span> archiveList:</span><br><span class="line">    archiveInfo = struct.pack(archiveInfoFormat, archiveOffsetPointer, secondsPerPoint, points)</span><br><span class="line">    fh.write(archiveInfo)</span><br><span class="line">    archiveOffsetPointer += (points * pointSize)</span><br></pre></td></tr></table></figure>
<h3 id="Write-Data"><a href="#Write-Data" class="headerlink" title="Write Data"></a>Write Data</h3><p>Because the database is just create, so there are no real data, the process will write some fake data: <code>\x00</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> CAN_FALLOCATE <span class="keyword">and</span> useFallocate:</span><br><span class="line">    remaining = archiveOffsetPointer - headerSize</span><br><span class="line">    fallocate(fh, headerSize, remaining)</span><br><span class="line"><span class="keyword">elif</span> sparse:</span><br><span class="line">    fh.seek(archiveOffsetPointer - <span class="number">1</span>)</span><br><span class="line">    fh.write(<span class="string">b'\x00'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    remaining = archiveOffsetPointer - headerSize</span><br><span class="line">    chunksize = <span class="number">16384</span></span><br><span class="line">    zeroes = <span class="string">b'\x00'</span> * chunksize</span><br><span class="line">    <span class="keyword">while</span> remaining &gt; chunksize:</span><br><span class="line">        fh.write(zeroes)</span><br><span class="line">        remaining -= chunksize</span><br><span class="line">    fh.write(zeroes[:remaining])</span><br></pre></td></tr></table></figure>
<h4 id="IO-optimization"><a href="#IO-optimization" class="headerlink" title="IO optimization"></a>IO optimization</h4><p>As you see, Whisper use several method to optimize the IO operation</p>
<h5 id="Fallocate"><a href="#Fallocate" class="headerlink" title="Fallocate"></a>Fallocate</h5><p>This is a Linux-specific system call. The function prototype is <code>int fallocate(int fd, int mode, off_t offset, off_t len);</code>. <code>fallocate()</code> allows the caller to directly manipulate the allocated disk space for the file referred to by <code>fd</code> for the byte range starting at <code>offset</code> and continuing for <code>len</code> bytes.</p>
<p>For more information, please see <a href="http://man7.org/linux/man-pages/man2/fallocate.2.html" target="_blank" rel="noopener">man fallocate</a></p>
<h5 id="Sparse-File"><a href="#Sparse-File" class="headerlink" title="Sparse File"></a>Sparse File</h5><p>File is not really allocate to the disk, only record some metadata to represent the length of file. Advantage of sparse file is very fast allocate speed at create time, disadvantage is when really write the data to the file for first, the disk space are allocate, this may lead to disk fragment. This will lead slower write and read speed.</p>
<p>For more information, please see <a href="https://en.wikipedia.org/wiki/Sparse_file" target="_blank" rel="noopener">Sparse file on Wikipedia</a></p>
<h5 id="Write-by-chunk"><a href="#Write-by-chunk" class="headerlink" title="Write by chunk"></a>Write by chunk</h5><p>If your data is several times bigger than disk sector, this will be the most effective. Modern computer has 4096 bytes (4KB) size disk sector. 4 times of 4k is 16384, so write by this number of data is effective too.</p>
<p>For more information, please see <a href="https://en.wikipedia.org/wiki/Disk_sector" target="_blank" rel="noopener">Disk sector on Wikipedia</a></p>
<h2 id="Query-process"><a href="#Query-process" class="headerlink" title="Query process"></a>Query process</h2><h3 id="preprocess-time-range"><a href="#preprocess-time-range" class="headerlink" title="preprocess time range"></a>preprocess time range</h3><p>According to the max retention, shrink the query time range:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> now <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">    now = int(time.time())</span><br><span class="line"><span class="keyword">if</span> untilTime <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">    untilTime = now</span><br><span class="line">fromTime = int(fromTime)</span><br><span class="line">untilTime = int(untilTime)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Here we try and be flexible and return as much data as we can.</span></span><br><span class="line"><span class="comment"># If the range of data is from too far in the past or fully in the future, we</span></span><br><span class="line"><span class="comment"># return nothing</span></span><br><span class="line"><span class="keyword">if</span> fromTime &gt; untilTime:</span><br><span class="line">    <span class="keyword">raise</span> InvalidTimeInterval(<span class="string">"Invalid time interval: from time '%s' is after until time '%s'"</span> % (fromTime, untilTime))</span><br><span class="line"></span><br><span class="line">oldestTime = now - header[<span class="string">'maxRetention'</span>]</span><br><span class="line"><span class="comment"># Range is in the future</span></span><br><span class="line"><span class="keyword">if</span> fromTime &gt; now:</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"><span class="comment"># Range is beyond retention</span></span><br><span class="line"><span class="keyword">if</span> untilTime &lt; oldestTime:</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"><span class="comment"># Range requested is partially beyond retention, adjust</span></span><br><span class="line"><span class="keyword">if</span> fromTime &lt; oldestTime:</span><br><span class="line">    fromTime = oldestTime</span><br><span class="line"><span class="comment"># Range is partially in the future, adjust</span></span><br><span class="line"><span class="keyword">if</span> untilTime &gt; now:</span><br><span class="line">    untilTime = now</span><br></pre></td></tr></table></figure>
<h3 id="Find-the-archive"><a href="#Find-the-archive" class="headerlink" title="Find the archive"></a>Find the archive</h3><p>Whisper will try to find the most precise archive:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">diff = now - fromTime</span><br><span class="line">for archive in header[&apos;archives&apos;]:</span><br><span class="line">  if archive[&apos;retention&apos;] &gt;= diff:</span><br><span class="line">      break</span><br></pre></td></tr></table></figure>
<h3 id="Justify-the-data-point"><a href="#Justify-the-data-point" class="headerlink" title="Justify the data point"></a>Justify the data point</h3><p>Arrange the time to time interval:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fromInterval = int(fromTime - (fromTime % archive[&apos;secondsPerPoint&apos;])) + archive[&apos;secondsPerPoint&apos;]</span><br><span class="line">untilInterval = int(untilTime - (untilTime % archive[&apos;secondsPerPoint&apos;])) + archive[&apos;secondsPerPoint&apos;]</span><br></pre></td></tr></table></figure>
<p>Summary, Whisper always find the next interval near the query time</p>
<p>Special, if the start interval same with the end interval, always contain next interval:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if fromInterval == untilInterval:</span><br><span class="line">    # Zero-length time range: always include the next point</span><br><span class="line">    untilInterval += archive[&apos;secondsPerPoint&apos;]</span><br></pre></td></tr></table></figure>
<h3 id="Compute-offset"><a href="#Compute-offset" class="headerlink" title="Compute offset"></a>Compute offset</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Determine fromOffset</span><br><span class="line">timeDistance = fromInterval - baseInterval</span><br><span class="line">pointDistance = timeDistance // archive[&apos;secondsPerPoint&apos;]</span><br><span class="line">byteDistance = pointDistance * pointSize</span><br><span class="line">fromOffset = archive[&apos;offset&apos;] + (byteDistance % archive[&apos;size&apos;])</span><br><span class="line"></span><br><span class="line"># Determine untilOffset</span><br><span class="line">timeDistance = untilInterval - baseInterval</span><br><span class="line">pointDistance = timeDistance // archive[&apos;secondsPerPoint&apos;]</span><br><span class="line">byteDistance = pointDistance * pointSize</span><br><span class="line">untilOffset = archive[&apos;offset&apos;] + (byteDistance % archive[&apos;size&apos;])</span><br></pre></td></tr></table></figure>
<h4 id="Trick-on-operation-in-Python"><a href="#Trick-on-operation-in-Python" class="headerlink" title="Trick on % operation in Python"></a>Trick on <code>%</code> operation in Python</h4><p>Whisper use <code>%</code> to archive the wrap effect:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">byteDistance % archive[<span class="string">'size'</span>]</span><br></pre></td></tr></table></figure>
<p>equal to</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if byteDistance &gt;= 0:</span><br><span class="line">    return byteDistance</span><br><span class="line">else:</span><br><span class="line">    return archive[&apos;size&apos;] + byteDistance</span><br></pre></td></tr></table></figure>
<p>The trick or feature of <code>%</code> operation is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(-3 % 5)</span><br><span class="line">#  output 2</span><br><span class="line">print(3 % 5)</span><br><span class="line">#  output 3</span><br></pre></td></tr></table></figure>
<h3 id="Read-data"><a href="#Read-data" class="headerlink" title="Read data"></a>Read data</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># Now we unpack the series data we just read (anything faster than unpack?)</span><br><span class="line">byteOrder, pointTypes = pointFormat[0], pointFormat[1:]</span><br><span class="line">points = len(seriesString) // pointSize</span><br><span class="line">seriesFormat = byteOrder + (pointTypes * points)</span><br><span class="line">unpackedSeries = struct.unpack(seriesFormat, seriesString)</span><br><span class="line"></span><br><span class="line"># And finally we construct a list of values (optimize this!)</span><br><span class="line">valueList = [None] * points  # Pre-allocate entire list for speed</span><br><span class="line">currentInterval = fromInterval</span><br><span class="line">step = archive[&apos;secondsPerPoint&apos;]</span><br><span class="line"></span><br><span class="line">for i in xrange(0, len(unpackedSeries), 2):</span><br><span class="line">pointTime = unpackedSeries[i]</span><br><span class="line">    if pointTime == currentInterval:</span><br><span class="line">          pointValue = unpackedSeries[i+1]</span><br><span class="line">          valueList[i//2] = pointValue  # In-place reassignment is faster than append()</span><br><span class="line">    currentInterval += step</span><br><span class="line"></span><br><span class="line">timeInfo = (fromInterval, untilInterval, step)</span><br><span class="line">return (timeInfo, valueList)</span><br></pre></td></tr></table></figure>
<p>Some key design in the process is that when Whisper read the data it will check weather the interval read from disk equal to expected timestamp. If not equaled, this means although here has a data point but the this not valid, it’s outdate data, then Whisper will use <code>None</code> as data value. This is very important this checker make Whisper can discrete write the disk and the result is always correct.</p>
<h2 id="Write-Update-data-process"><a href="#Write-Update-data-process" class="headerlink" title="Write / Update data process"></a>Write / Update data process</h2><p>Although Whisper have two update interface: <code>update()</code> and <code>update_many()</code>, but the latter interface support write multiply data point at one call. In the Carbon application, it almost use <code>update_many()</code>, which have better IO performance. Fallow text will cover <code>update_many()</code> but don’t worry about the <code>update()</code>, their are almost the same thing.</p>
<h3 id="pre-require"><a href="#pre-require" class="headerlink" title="pre-require"></a>pre-require</h3><ul>
<li>path : Database file location</li>
<li>points : a list of point ((timestamp, value) pair</li>
</ul>
<h3 id="Order-the-points"><a href="#Order-the-points" class="headerlink" title="Order the points"></a>Order the points</h3><p>Order the points by timestamp in the descending order, after that the newer point will at the head of list.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">points = [(int(t), float(v)) <span class="keyword">for</span> (t, v) <span class="keyword">in</span> points]</span><br><span class="line">points.sort(key=<span class="keyword">lambda</span> p: p[<span class="number">0</span>], reverse=<span class="keyword">True</span>)  <span class="comment"># Order points by timestamp, newest first</span></span><br></pre></td></tr></table></figure>
<h3 id="Group-the-data-point-by-retention"><a href="#Group-the-data-point-by-retention" class="headerlink" title="Group the data point by retention"></a>Group the data point by retention</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> point <span class="keyword">in</span> points:</span><br><span class="line">    age = now - point[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> currentArchive[<span class="string">'retention'</span>] &lt; age:  <span class="comment"># We can't fit any more points in this archive</span></span><br><span class="line">        <span class="keyword">if</span> currentPoints:  <span class="comment"># Commit all the points we've found that it can fit</span></span><br><span class="line">            currentPoints.reverse()  <span class="comment"># Put points in chronological order</span></span><br><span class="line">            __archive_update_many(fh, header, currentArchive, currentPoints)</span><br><span class="line">            currentPoints = []</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            currentArchive = next(archives)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            currentArchive = <span class="keyword">None</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> currentArchive:</span><br><span class="line">        <span class="keyword">break</span>  <span class="comment"># Drop remaining points that don't fit in the database</span></span><br><span class="line"></span><br><span class="line">    currentPoints.append(point)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> currentArchive <span class="keyword">and</span> currentPoints:  <span class="comment"># Don't forget to commit after we've checked all the archives</span></span><br><span class="line">    currentPoints.reverse()</span><br><span class="line">    __archive_update_many(fh, header, currentArchive, currentPoints)</span><br></pre></td></tr></table></figure>
<p>It’s not easy to make clear what’s operation do: data will write from higher precision archive to lower precision one. If the data is belong to this archive, it will write by this archive, if out the retention, leave the data to next (lower precision) archive.</p>
<p>This is important that, before all the data pass to writer function <code>__archive_update_many</code>, their all do the order reverse by <code>currentPoints.reverse()</code></p>
<h3 id="Arrange-the-data-point"><a href="#Arrange-the-data-point" class="headerlink" title="Arrange the data point"></a>Arrange the data point</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">step = archive[<span class="string">'secondsPerPoint'</span>]</span><br><span class="line">alignedPoints = [(timestamp - (timestamp % step), value)</span><br><span class="line">                <span class="keyword">for</span> (timestamp, value) <span class="keyword">in</span> points]</span><br></pre></td></tr></table></figure>
<h3 id="Group-the-data-by-timestamp-gap"><a href="#Group-the-data-by-timestamp-gap" class="headerlink" title="Group the data by timestamp gap"></a>Group the data by timestamp gap</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a packed string for each contiguous sequence of points</span></span><br><span class="line">packedStrings = []</span><br><span class="line">previousInterval = <span class="keyword">None</span></span><br><span class="line">currentString = <span class="string">b""</span></span><br><span class="line">lenAlignedPoints = len(alignedPoints)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, lenAlignedPoints):</span><br><span class="line">    <span class="comment"># Take last point in run of points with duplicate intervals</span></span><br><span class="line">    <span class="keyword">if</span> i + <span class="number">1</span> &lt; lenAlignedPoints <span class="keyword">and</span> alignedPoints[i][<span class="number">0</span>] == alignedPoints[i + <span class="number">1</span>][<span class="number">0</span>]:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    (interval, value) = alignedPoints[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the point is the start point or the it's continue point from previous</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> previousInterval) <span class="keyword">or</span> (interval == previousInterval + step):</span><br><span class="line">        currentString += struct.pack(pointFormat, interval, value)</span><br><span class="line">        previousInterval = interval</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment">#  if the timestamp continue is breaked</span></span><br><span class="line">        numberOfPoints = len(currentString) // pointSize</span><br><span class="line">        startInterval = previousInterval - (step * (numberOfPoints - <span class="number">1</span>))</span><br><span class="line">        packedStrings.append((startInterval, currentString))</span><br><span class="line">        currentString = struct.pack(pointFormat, interval, value)</span><br><span class="line">        previousInterval = interval</span><br><span class="line"><span class="keyword">if</span> currentString:</span><br><span class="line">    numberOfPoints = len(currentString) // pointSize</span><br><span class="line">    startInterval = previousInterval - (step * (numberOfPoints - <span class="number">1</span>))</span><br><span class="line">    packedStrings.append((startInterval, currentString))</span><br></pre></td></tr></table></figure>
<p><strong>Important:</strong></p>
<blockquote>
<p>Take last point in run of points with duplicate intervals</p>
</blockquote>
<p>This is a very important feature.</p>
<h3 id="Write-data"><a href="#Write-data" class="headerlink" title="Write data"></a>Write data</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Read base point and determine where our writes will start</span></span><br><span class="line">fh.seek(archive[<span class="string">'offset'</span>])</span><br><span class="line">packedBasePoint = fh.read(pointSize)</span><br><span class="line">(baseInterval, baseValue) = struct.unpack(pointFormat, packedBasePoint)</span><br><span class="line"><span class="keyword">if</span> baseInterval == <span class="number">0</span>:  <span class="comment"># This file's first update</span></span><br><span class="line">    baseInterval = packedStrings[<span class="number">0</span>][<span class="number">0</span>]  <span class="comment"># Use our first string as the base, so we start at the start</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write all of our packed strings in locations determined by the baseInterval</span></span><br><span class="line"><span class="keyword">for</span> (interval, packedString) <span class="keyword">in</span> packedStrings:</span><br><span class="line">    timeDistance = interval - baseInterval</span><br><span class="line">    pointDistance = timeDistance // step</span><br><span class="line">    byteDistance = pointDistance * pointSize</span><br><span class="line">    myOffset = archive[<span class="string">'offset'</span>] + (byteDistance % archive[<span class="string">'size'</span>])</span><br><span class="line">    fh.seek(myOffset)</span><br><span class="line">    archiveEnd = archive[<span class="string">'offset'</span>] + archive[<span class="string">'size'</span>]</span><br><span class="line">    bytesBeyond = (myOffset + len(packedString)) - archiveEnd</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> bytesBeyond &gt; <span class="number">0</span>:</span><br><span class="line">        fh.write(packedString[:-bytesBeyond])</span><br><span class="line">        <span class="keyword">assert</span> fh.tell() == archiveEnd, <span class="string">"archiveEnd=%d fh.tell=%d bytesBeyond=%d len(packedString)=%d"</span> % (</span><br><span class="line">        archiveEnd, fh.tell(), bytesBeyond, len(packedString))</span><br><span class="line">        fh.seek(archive[<span class="string">'offset'</span>])</span><br><span class="line">        fh.write(</span><br><span class="line">            packedString[-bytesBeyond:])  <span class="comment"># Safe because it can't exceed the archive (retention checking logic above)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        fh.write(packedString)</span><br></pre></td></tr></table></figure>
<p>Note here: Write function have warp feature.</p>
<h3 id="Aggregator"><a href="#Aggregator" class="headerlink" title="Aggregator"></a>Aggregator</h3><p>All the archive will try to aggregate to the next archive</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Now we propagate the updates to lower-precision archives</span></span><br><span class="line">higher = archive</span><br><span class="line">lowerArchives = [arc <span class="keyword">for</span> arc <span class="keyword">in</span> header[<span class="string">'archives'</span>] <span class="keyword">if</span> arc[<span class="string">'secondsPerPoint'</span>] &gt; archive[<span class="string">'secondsPerPoint'</span>]]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> lower <span class="keyword">in</span> lowerArchives:</span><br><span class="line">    fit = <span class="keyword">lambda</span> i: i - (i % lower[<span class="string">'secondsPerPoint'</span>])</span><br><span class="line">    lowerIntervals = [fit(p[<span class="number">0</span>]) <span class="keyword">for</span> p <span class="keyword">in</span> alignedPoints]</span><br><span class="line">    uniqueLowerIntervals = set(lowerIntervals)</span><br><span class="line">    propagateFurther = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">for</span> interval <span class="keyword">in</span> uniqueLowerIntervals:</span><br><span class="line">        <span class="keyword">if</span> __propagate(fh, header, interval, higher, lower):</span><br><span class="line">            propagateFurther = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> propagateFurther:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    higher = lower</span><br></pre></td></tr></table></figure>
<h4 id="Aggregation-method-on-single-point"><a href="#Aggregation-method-on-single-point" class="headerlink" title="Aggregation method on single point"></a>Aggregation method on single point</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__propagate</span><span class="params">(fh, header, timestamp, higher, lower)</span>:</span></span><br><span class="line">    aggregationMethod = header[<span class="string">'aggregationMethod'</span>]</span><br><span class="line">    xff = header[<span class="string">'xFilesFactor'</span>]</span><br><span class="line"></span><br><span class="line">    lowerIntervalStart = timestamp - (timestamp % lower[<span class="string">'secondsPerPoint'</span>])</span><br><span class="line">    lowerIntervalEnd = lowerIntervalStart + lower[<span class="string">'secondsPerPoint'</span>]</span><br><span class="line"></span><br><span class="line">    fh.seek(higher[<span class="string">'offset'</span>])</span><br><span class="line">    packedPoint = fh.read(pointSize)</span><br><span class="line">    (higherBaseInterval, higherBaseValue) = struct.unpack(pointFormat, packedPoint)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> higherBaseInterval == <span class="number">0</span>:</span><br><span class="line">        higherFirstOffset = higher[<span class="string">'offset'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        timeDistance = lowerIntervalStart - higherBaseInterval</span><br><span class="line">        pointDistance = timeDistance // higher[<span class="string">'secondsPerPoint'</span>]</span><br><span class="line">        byteDistance = pointDistance * pointSize</span><br><span class="line">        higherFirstOffset = higher[<span class="string">'offset'</span>] + (byteDistance % higher[<span class="string">'size'</span>])</span><br><span class="line"></span><br><span class="line">    higherPoints = lower[<span class="string">'secondsPerPoint'</span>] // higher[<span class="string">'secondsPerPoint'</span>]</span><br><span class="line">    higherSize = higherPoints * pointSize</span><br><span class="line">    relativeFirstOffset = higherFirstOffset - higher[<span class="string">'offset'</span>]</span><br><span class="line">    relativeLastOffset = (relativeFirstOffset + higherSize) % higher[<span class="string">'size'</span>]</span><br><span class="line">    higherLastOffset = relativeLastOffset + higher[<span class="string">'offset'</span>]</span><br><span class="line">    fh.seek(higherFirstOffset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> higherFirstOffset &lt; higherLastOffset:  <span class="comment"># We don't wrap the archive</span></span><br><span class="line">        seriesString = fh.read(higherLastOffset - higherFirstOffset)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># We do wrap the archive</span></span><br><span class="line">        higherEnd = higher[<span class="string">'offset'</span>] + higher[<span class="string">'size'</span>]</span><br><span class="line">        seriesString = fh.read(higherEnd - higherFirstOffset)</span><br><span class="line">        fh.seek(higher[<span class="string">'offset'</span>])</span><br><span class="line">        seriesString += fh.read(higherLastOffset - higher[<span class="string">'offset'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Now we unpack the series data we just read</span></span><br><span class="line">    byteOrder, pointTypes = pointFormat[<span class="number">0</span>], pointFormat[<span class="number">1</span>:]</span><br><span class="line">    points = len(seriesString) // pointSize</span><br><span class="line">    seriesFormat = byteOrder + (pointTypes * points)</span><br><span class="line">    unpackedSeries = struct.unpack(seriesFormat, seriesString)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># And finally we construct a list of values</span></span><br><span class="line">    neighborValues = [<span class="keyword">None</span>] * points</span><br><span class="line">    currentInterval = lowerIntervalStart</span><br><span class="line">    step = higher[<span class="string">'secondsPerPoint'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, len(unpackedSeries), <span class="number">2</span>):</span><br><span class="line">        pointTime = unpackedSeries[i]</span><br><span class="line">        <span class="keyword">if</span> pointTime == currentInterval:</span><br><span class="line">            neighborValues[i // <span class="number">2</span>] = unpackedSeries[i + <span class="number">1</span>]</span><br><span class="line">        currentInterval += step</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Propagate aggregateValue to propagate from neighborValues if we have enough known points</span></span><br><span class="line">    knownValues = [v <span class="keyword">for</span> v <span class="keyword">in</span> neighborValues <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> knownValues:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    knownPercent = float(len(knownValues)) / float(len(neighborValues))</span><br><span class="line">    <span class="keyword">if</span> knownPercent &gt;= xff:  <span class="comment"># We have enough data to propagate a value!</span></span><br><span class="line">        aggregateValue = aggregate(aggregationMethod, knownValues, neighborValues)</span><br><span class="line">        myPackedPoint = struct.pack(pointFormat, lowerIntervalStart, aggregateValue)</span><br><span class="line">        fh.seek(lower[<span class="string">'offset'</span>])</span><br><span class="line">        packedPoint = fh.read(pointSize)</span><br><span class="line">        (lowerBaseInterval, lowerBaseValue) = struct.unpack(pointFormat, packedPoint)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> lowerBaseInterval == <span class="number">0</span>:  <span class="comment"># First propagated update to this lower archive</span></span><br><span class="line">            fh.seek(lower[<span class="string">'offset'</span>])</span><br><span class="line">            fh.write(myPackedPoint)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># Not our first propagated update to this lower archive</span></span><br><span class="line">            timeDistance = lowerIntervalStart - lowerBaseInterval</span><br><span class="line">            pointDistance = timeDistance // lower[<span class="string">'secondsPerPoint'</span>]</span><br><span class="line">            byteDistance = pointDistance * pointSize</span><br><span class="line">            lowerOffset = lower[<span class="string">'offset'</span>] + (byteDistance % lower[<span class="string">'size'</span>])</span><br><span class="line">            fh.seek(lowerOffset)</span><br><span class="line">            fh.write(myPackedPoint)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>If the <code>xff</code> (too much invalid point below the threhold) lead the aggregation failed, the next level aggregation will be cancled.</p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="IO-operation"><a href="#IO-operation" class="headerlink" title="IO operation"></a>IO operation</h3><p>Whisper’s author do some effect on the IO optimise. When open the file, Whisper use <code>fadvise</code> to tell OS optimise the IO operation.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> CAN_FADVISE <span class="keyword">and</span> FADVISE_RANDOM:</span><br><span class="line">    posix_fadvise(fh.fileno(), <span class="number">0</span>, <span class="number">0</span>, POSIX_FADV_RANDOM)</span><br></pre></td></tr></table></figure>
<p>Let’s see how manual say about <code>fadvise</code>:</p>
<blockquote>
<p>Allows an application to to tell the kernel how it expects to use a file handle, so that the kernel can choose appropriate read-ahead and caching techniques for access to the corresponding file.</p>
</blockquote>
<p><code>fadvise</code> have several options:</p>
<ul>
<li><code>FADV_NORMAL</code> ：No special treatment</li>
<li><code>FADV_RANDOM</code> : Expect page references in random order</li>
<li><code>FADV_SEQUENTIAL</code> : Expect page references in sequential order</li>
<li><code>FADV_WILLNEED</code> : Expect access in the near future</li>
<li><code>FADV_DONTNEED</code> : Do not expect access in the near future. Subsequent access of pages in this range will succeed, but will result either in reloading of the memory contents from the underlying mapped file or zero-fill-in-demand pages for mappings without an underlying file</li>
<li><code>FADV_NOREUSE</code> : Access data only once</li>
</ul>
<p>For more information, please see <a href="https://linux.die.net/man/2/fadvise" target="_blank" rel="noopener">man fadvise</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/时间数据库Whisper的实现简介/" rel="prev" title="时间数据库Whisper的实现简介">
                时间数据库Whisper的实现简介 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Xiaoquan Kong" />
            
              <p class="site-author-name" itemprop="name">Xiaoquan Kong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/howl-anderson" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.linkedin.com/in/xiaoquankong/" target="_blank" title="Linkedin"><i class="fa fa-fw fa-linkedin"></i>Linkedin</a>
                  
                </span>
              
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
              </a>
            </div>
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#What’s-the-Whisper"><span class="nav-number">1.</span> <span class="nav-text">What’s the Whisper</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview-the-structure-of-the-Whisper-database"><span class="nav-number">2.</span> <span class="nav-text">Overview the structure of the Whisper database</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">2.1.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Header"><span class="nav-number">2.2.</span> <span class="nav-text">Header</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#aggregationType"><span class="nav-number">2.2.1.</span> <span class="nav-text">aggregationType</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#maxRetention"><span class="nav-number">2.2.2.</span> <span class="nav-text">maxRetention</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xff"><span class="nav-number">2.2.3.</span> <span class="nav-text">xff</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#archiveCount"><span class="nav-number">2.2.4.</span> <span class="nav-text">archiveCount</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Archives"><span class="nav-number">2.3.</span> <span class="nav-text">Archives</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#summary"><span class="nav-number">2.3.1.</span> <span class="nav-text">summary</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#structure"><span class="nav-number">2.3.2.</span> <span class="nav-text">structure</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#offset"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">offset</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#secondsPerPoint"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">secondsPerPoint</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#points"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">points</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#derivative"><span class="nav-number">2.3.2.4.</span> <span class="nav-text">derivative</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#retention"><span class="nav-number">2.3.2.4.1.</span> <span class="nav-text">retention</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#size"><span class="nav-number">2.3.2.4.2.</span> <span class="nav-text">size</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data"><span class="nav-number">2.4.</span> <span class="nav-text">Data</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#summary-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">summary</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Point"><span class="nav-number">2.4.2.</span> <span class="nav-text">Point</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Interval"><span class="nav-number">2.4.2.1.</span> <span class="nav-text">Interval</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Data-1"><span class="nav-number">2.4.2.2.</span> <span class="nav-text">Data</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conclusion"><span class="nav-number">2.5.</span> <span class="nav-text">Conclusion</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ASCII-Art-Chart"><span class="nav-number">2.5.1.</span> <span class="nav-text">ASCII Art Chart</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-process"><span class="nav-number">3.</span> <span class="nav-text">Create process</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pre-requires"><span class="nav-number">3.1.</span> <span class="nav-text">pre-requires</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#check-archiveList"><span class="nav-number">3.2.</span> <span class="nav-text">check archiveList</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Trap-on-the-implementation"><span class="nav-number">3.2.1.</span> <span class="nav-text">Trap on the implementation</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-Header"><span class="nav-number">3.3.</span> <span class="nav-text">Write Header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-ArchiveList"><span class="nav-number">3.4.</span> <span class="nav-text">Write ArchiveList</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-Data"><span class="nav-number">3.5.</span> <span class="nav-text">Write Data</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IO-optimization"><span class="nav-number">3.5.1.</span> <span class="nav-text">IO optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Fallocate"><span class="nav-number">3.5.1.1.</span> <span class="nav-text">Fallocate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sparse-File"><span class="nav-number">3.5.1.2.</span> <span class="nav-text">Sparse File</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Write-by-chunk"><span class="nav-number">3.5.1.3.</span> <span class="nav-text">Write by chunk</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Query-process"><span class="nav-number">4.</span> <span class="nav-text">Query process</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#preprocess-time-range"><span class="nav-number">4.1.</span> <span class="nav-text">preprocess time range</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Find-the-archive"><span class="nav-number">4.2.</span> <span class="nav-text">Find the archive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Justify-the-data-point"><span class="nav-number">4.3.</span> <span class="nav-text">Justify the data point</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compute-offset"><span class="nav-number">4.4.</span> <span class="nav-text">Compute offset</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Trick-on-operation-in-Python"><span class="nav-number">4.4.1.</span> <span class="nav-text">Trick on % operation in Python</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-data"><span class="nav-number">4.5.</span> <span class="nav-text">Read data</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Update-data-process"><span class="nav-number">5.</span> <span class="nav-text">Write / Update data process</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pre-require"><span class="nav-number">5.1.</span> <span class="nav-text">pre-require</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Order-the-points"><span class="nav-number">5.2.</span> <span class="nav-text">Order the points</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Group-the-data-point-by-retention"><span class="nav-number">5.3.</span> <span class="nav-text">Group the data point by retention</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Arrange-the-data-point"><span class="nav-number">5.4.</span> <span class="nav-text">Arrange the data point</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Group-the-data-by-timestamp-gap"><span class="nav-number">5.5.</span> <span class="nav-text">Group the data by timestamp gap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-data"><span class="nav-number">5.6.</span> <span class="nav-text">Write data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Aggregator"><span class="nav-number">5.7.</span> <span class="nav-text">Aggregator</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Aggregation-method-on-single-point"><span class="nav-number">5.7.1.</span> <span class="nav-text">Aggregation method on single point</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MISC"><span class="nav-number">6.</span> <span class="nav-text">MISC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IO-operation"><span class="nav-number">6.1.</span> <span class="nav-text">IO operation</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiaoquan Kong</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>








        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  

  
    <script id="dsq-count-scr" src="https://blog-xiaoquankong-ai.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https://blog.xiaoquankong.ai/introduce-to-the-implement-of-whisper-the-time-serial-database/';
        this.page.identifier = 'introduce-to-the-implement-of-whisper-the-time-serial-database/';
        this.page.title = 'Introduce to the implement of Whisper: the time-serial database';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://blog-xiaoquankong-ai.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  





	





  












  





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

  

</body>
</html>
